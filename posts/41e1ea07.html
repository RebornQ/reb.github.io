<!DOCTYPE html><html style="display:none" lang="zh"><head><meta charset="utf-8"><script>window.materialVersion="1.4.0"</script><title>全站开启https总结（艰苦历程？） | Reborn&#39;s Blog</title><meta http-equiv="x-dns-prefetch-control" content="on"><meta http-equiv="X-UA-Compatible"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="theme-color" content="#0097A7"><meta name="author" content="Reborn"><meta name="description" itemprop="description" content="前言在搭建完Hexo之后，我就开始思考要不要配置https呢？最后深思熟虑，还是决定上https吧！毕竟现在https已经开始普及，像Chrome、Firfox这些浏览器如果不是https协议的会提示如下图，警告“不安全”什么的。强迫症患者表示看着最不舒服了（逃～于是我就开始了配置https之路……"><meta name="keywords" content="Reborn,reborn,blog,hexo,Android,Web,reb,technology,博客,逆向,技术,运维,服务器,Linux,SSL"><link rel="icon shortcut" type="image/ico" href="/img/favicon-Z.png"><link rel="icon" sizes="192x192" href="/img/favicon-Z.png"><link rel="apple-touch-icon" href="/img/favicon-Z.png"><meta name="apple-mobile-web-app-title" content="Title"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="480"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="apple-mobile-web-app-title" content="Reborn&#39;s Blog"><meta property="og:url" content="https://reb.mallotec.com"><meta property="og:type" content="blog"><meta property="og:title" content="全站开启https总结（艰苦历程？） | Reborn&#39;s Blog"><meta property="og:image" content="/img/favicon-Z.png"><meta property="og:description" content="前言在搭建完Hexo之后，我就开始思考要不要配置https呢？最后深思熟虑，还是决定上https吧！毕竟现在https已经开始普及，像Chrome、Firfox这些浏览器如果不是https协议的会提示如下图，警告“不安全”什么的。强迫症患者表示看着最不舒服了（逃～于是我就开始了配置https之路……"><meta property="og:article:tag" content="运维"><meta property="og:article:tag" content="服务器"><meta property="og:article:tag" content="Linux"><meta property="og:article:tag" content="SSL"><meta property="article:published_time" content="7月 21, 2018"><meta property="article:modified_time" content="8月 03, 2018"><meta name="twitter:title" content="全站开启https总结（艰苦历程？） | Reborn&#39;s Blog"><meta name="twitter:description" content="前言在搭建完Hexo之后，我就开始思考要不要配置https呢？最后深思熟虑，还是决定上https吧！毕竟现在https已经开始普及，像Chrome、Firfox这些浏览器如果不是https协议的会提示如下图，警告“不安全”什么的。强迫症患者表示看着最不舒服了（逃～于是我就开始了配置https之路……"><meta name="twitter:image" content="/img/favicon-Z.png"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:url" content="https://reb.mallotec.com"><link rel="canonical" href="https://reb.mallotec.com/posts/41e1ea07.html"><script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Reborn&#39;s Blog",
        "logo": "/img/favicon-Z.png"
    },
    "author": {
        "@type": "Person",
        "name": "Reborn",
        "image": {
            "@type": "ImageObject",
            "url": "/img/favicon-Z.png"
        },
        "description": "一壶酒，一蓑衣，渔歌唱晚，了此一生"
    },
    "headline": "全站开启https总结（艰苦历程？）",
    "url": "https://reb.mallotec.com/posts/41e1ea07.html",
    "datePublished": "7月 21, 2018",
    "dateModified": "8月 03, 2018",
    "description": "前言在搭建完Hexo之后，我就开始思考要不要配置https呢？最后深思熟虑，还是决定上https吧！毕竟现在https已经开始普及，像Chrome、Firfox这些浏览器如果不是https协议的会提示如下图，警告“不安全”什么的。强迫症患者表示看着最不舒服了（逃～于是我就开始了配置https之路……",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://reb.mallotec.com"
    }
}</script><!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]--><script>window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}},lsloader.removeLS=function(e){try{localStorage.removeItem(e)}catch(e){}},lsloader.setLS=function(e,t){try{localStorage.setItem(e,t)}catch(e){}},lsloader.getLS=function(e){var t="";try{t=localStorage.getItem(e)}catch(e){t=""}return t},versionString="/*"+materialVersion+"*/",lsloader.clean=function(){try{for(var e=[],t=0;t<localStorage.length;t++)e.push(localStorage.key(t));e.forEach(function(e){var t=lsloader.getLS(e);t&&-1===t.indexOf(versionString)&&lsloader.removeLS(e)})}catch(e){}},lsloader.clean(),lsloader.load=function(e,t,s){var n;if(s=s||function(){},(n=this.getLS(e))&&-1===n.indexOf(versionString))return this.removeLS(e),void this.requestResource(e,t,s);if(n){var a=n.split(versionString)[0];if(a!=t)return console.log("reload:"+t),this.removeLS(e),void this.requestResource(e,t,s);n=n.split(versionString)[1],/\.js?.+$/.test(a)?(this.jsRunSequence.push({name:e,code:n}),this.runjs(t,e,n)):(document.getElementById(e).appendChild(document.createTextNode(n)),s())}else this.requestResource(e,t,s)},lsloader.requestResource=function(t,s,e){var n=this;/\.js?.+$/.test(s)?this.iojs(s,t,function(e,t,s){n.setLS(t,e+versionString+s),n.runjs(e,t,s)}):/\.css?.+$/.test(s)&&this.iocss(s,t,function(e){document.getElementById(t).appendChild(document.createTextNode(e)),n.setLS(t,s+versionString+e)},e)},lsloader.iojs=function(e,t,s){var n=this;n.jsRunSequence.push({name:t,code:""});try{var a=new XMLHttpRequest;a.open("get",e,!0),a.onreadystatechange=function(){if(4==a.readyState){if((200<=a.status&&a.status<300||304==a.status)&&""!=a.response)return void s(e,t,a.response);n.jsfallback(e,t)}},a.send(null)}catch(s){n.jsfallback(e,t)}},lsloader.iocss=function(e,t,s,n){var a=this;try{var u=new XMLHttpRequest;u.open("get",e,!0),u.onreadystatechange=function(){if(4==u.readyState){if((200<=u.status&&u.status<300||304==u.status)&&""!=u.response)return s(u.response),void n();a.cssfallback(e,t,n)}},u.send(null)}catch(s){a.cssfallback(e,t,n)}},lsloader.iofonts=function(e,t,s,n){var a=this;try{var u=new XMLHttpRequest;u.open("get",e,!0),u.onreadystatechange=function(){if(4==u.readyState){if((200<=u.status&&u.status<300||304==u.status)&&""!=u.response)return s(u.response),void n();a.cssfallback(e,t,n)}},u.send(null)}catch(s){a.cssfallback(e,t,n)}},lsloader.runjs=function(e,t,s){if(t&&s)for(var n in this.jsRunSequence)this.jsRunSequence[n].name==t&&(this.jsRunSequence[n].code=s);if(this.jsRunSequence[0]&&this.jsRunSequence[0].code&&"failed"!=this.jsRunSequence[0].status)(a=document.createElement("script")).appendChild(document.createTextNode(this.jsRunSequence[0].code)),a.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(a),this.jsRunSequence.shift(),0<this.jsRunSequence.length&&this.runjs();else if(this.jsRunSequence[0]&&"failed"==this.jsRunSequence[0].status){var a,u=this;(a=document.createElement("script")).src=this.jsRunSequence[0].path,a.type="text/javascript",this.jsRunSequence[0].status="loading",a.onload=function(){u.jsRunSequence.shift(),0<u.jsRunSequence.length&&u.runjs()},document.body.appendChild(a)}},lsloader.tagLoad=function(e,t){this.jsRunSequence.push({name:t,code:"",path:e,status:"failed"}),this.runjs()},lsloader.jsfallback=function(e,t){if(!this.jsnamemap[t]){for(var s in this.jsnamemap[t]=t,this.jsRunSequence)this.jsRunSequence[s].name==t&&(this.jsRunSequence[s].code="",this.jsRunSequence[s].status="failed",this.jsRunSequence[s].path=e);this.runjs()}},lsloader.cssfallback=function(e,t,s){if(!this.cssnamemap[t]){this.cssnamemap[t]=1;var n=document.createElement("link");n.type="text/css",n.href=e,n.rel="stylesheet",n.onload=n.onerror=s;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(n,a)}},lsloader.runInlineScript=function(e,t){var s=document.getElementById(t).innerText;this.jsRunSequence.push({name:e,code:s}),this.runjs()},lsloader.loadCombo=function(e){var t="",s={};for(var n in e){var a=this.getLS(e[n].name);if(a)var u=a.split(versionString)[0],i=a.split(versionString)[1];else u="";u==e[n].path?this.jsRunSequence.push({name:e[n].name,code:i,path:e[n].path}):(this.jsRunSequence.push({name:e[n].name,code:null,path:e[n].path,status:"comboloading"}),s[e[n].name]=!0,t+=(""==t?"":";")+e[n].path)}var o=this;if(t){var r=new XMLHttpRequest;r.open("get",combo+t,!0),r.onreadystatechange=function(){if(4==r.readyState)if(200<=r.status&&r.status<300||304==r.status){if(""!=r.response)return void o.runCombo(r.response,s)}else{for(var e in o.jsRunSequence)s[o.jsRunSequence[e].name]&&(o.jsRunSequence[e].status="failed");o.runjs()}},r.send(null)}this.runjs()},lsloader.runCombo=function(e,t){for(var s in(e=e.split("/*combojs*/")).shift(),this.jsRunSequence)t[this.jsRunSequence[s].name]&&e[0]&&(this.jsRunSequence[s].status="comboJS",this.jsRunSequence[s].code=e[0],this.setLS(this.jsRunSequence[s].name,this.jsRunSequence[s].path+versionString+e[0]),e.shift());this.runjs()}</script><style id="css/material.min.css"></style><script>void 0===window.lsLoadCSSMaxNums&&(window.lsLoadCSSMaxNums=0),window.lsLoadCSSMaxNums++,lsloader.load("css/material.min.css","/css/material.min.css?fJTiM/K1J3dWIruo3pxtAw==",function(){void 0===window.lsLoadCSSNums&&(window.lsLoadCSSNums=0),window.lsLoadCSSNums++,window.lsLoadCSSNums==window.lsLoadCSSMaxNums&&(document.documentElement.style.display="")})</script><style id="css/style.min.css"></style><script>void 0===window.lsLoadCSSMaxNums&&(window.lsLoadCSSMaxNums=0),window.lsLoadCSSMaxNums++,lsloader.load("css/style.min.css","/css/style.min.css?pF62FpOwRGzfu5iwuGITBA==",function(){void 0===window.lsLoadCSSNums&&(window.lsLoadCSSNums=0),window.lsLoadCSSNums++,window.lsLoadCSSNums==window.lsLoadCSSMaxNums&&(document.documentElement.style.display="")})</script><style>.footer-sns-github{background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNCA3OGMtNi40IDEuNC0yNi40IDE0LjItMzYgMjIuOC04IDcuMi0yMiAyOS44LTI0LjQgMzkuMi0xLjYgNi40LTIgMTEzLjItMS42IDM2OCAuNiAyOTkuNCAxIDM1OS44IDMuNCAzNjQgMTEgMjAuMiAyMS42IDMyLjQgMzcuMiA0MyAxNS42IDEwLjYgMTcuMiAxMS4yIDM0LjIgMTMuMiAxMC42IDEuMiA2My40IDEuNiAxMjcuNiAxLjRsMTA5LjYtLjYgNi02LjggNi4yLTYuOC0xLjItMjUuMmMtLjgtMTUuOC0uMi0zMy40IDEuNC00Ny4yIDMtMjUuNCAxLjQtMzYuMi02LTQzLjItNS00LjYtNi4yLTQuOC0zMC42LTQuMi0yNy42LjgtMjQgMS42LTY4LjgtMTYtOC42LTMuNC0yMi42LTE4LTI4LjQtMjkuOC0xMS40LTIyLjgtMjctNDUtMzkuMi01NS42LTE0LTEyLjItMTkuOC0yMC44LTE5LjgtMjguNiAwLTExLjYgMTMuNi0xMi42IDMzLjItMi40IDE2LjYgOC44IDIwLjggMTIuNCA0MC44IDM2LjIgMjQuMiAyOC42IDMxIDMzLjYgNTQgMzkuNiAxNS4yIDQgNDIuMiAzIDUxLjQtMS44IDktNC42IDE4LTE1LjIgMjQuNC0yOS4yIDExLjQtMjQuMiA3LjQtMzEuMi0yMC42LTM2LjgtOS44LTItMjkuMi04LTQzLjQtMTMuNC00MC40LTE1LjgtNjQuNi0zNy40LTg1LjQtNzYuMi0xMS42LTIxLjgtMTUuNC0zMy0xOC4yLTUzLjYtNC4yLTMyLjItNC44LTYwLjItMS40LTg0IDMuNC0yMy44IDYuOC0zMi44IDIwLjItNTQgNC02IDguOC0xNS42IDExLTIxLjQgMy44LTEwIDMuOC0xMS42IDEtMzAtNS4yLTM0LjItMy4yLTUyLjQgNy42LTcwLjIgNy4yLTEyLjIgMTUtMTcuMiAyNC4yLTE1LjggMTIuOCAyLjIgNTIgMTcuNCA2Ni44IDI2LjIgMjYgMTUgMjkgMTUuNCA4Mi40IDcuMiAyNC42LTMuOCAzMy44LTQuMiA2MC0zLjIgMTcgLjYgNDEuNCAzIDU0IDUuMiAzOC40IDYuNiA0OS42IDUuMiA3My0xMCA2LjYtNC4yIDE3LjQtOS40IDI0LTExLjYgNi42LTIuMiAxNi01LjggMjEtOC4yIDEzLTYgMjgtNS42IDM1LjYuOCAxMi40IDEwLjQgMTguNiA0MS40IDE0LjQgNzEuNi00LjQgMzAuNi0zIDM5LjQgOC40IDUzLjggMy40IDQuNCAxMS4yIDE5LjIgMTcuNCAzMy4yTDc3NSA0NDN2NzhsLTEwIDI4Yy0xNS4yIDQzLjItMzYuOCA3My4yLTY2LjIgOTIuOC0xMy40IDguOC01NyAyNS40LTc2LjggMjktMjguMiA1LjItMzMuMiAxMi42LTIyIDMyLjIgMTEuMiAxOS40IDEyLjQgMzIuOCAxMS42IDEyOS42bC0uNiA4NS44IDUuNCA0LjZjMy42IDMgOS4yIDUuMiAxNiA2IDUuOC44IDYwLjIgMSAxMjAuNi42IDEwOC40LS42IDExMC4yLS42IDExOS01IDI0LTExLjYgNDAtMjcuNCA1MS42LTUwLjZsNS40LTExIC42LTM0N2MuNC0yMjMtLjItMzUzLjQtMS40LTM2NS0yLTE3LTIuNi0xOC42LTEzLTM0LTEwLjYtMTUuNC0yMi44LTI2LjItNDMuMi0zNy4yLTQuMi0yLjQtNjQuNi0yLjgtMzY2LTMuMi0xOTguNiAwLTM2NCAuNC0zNjcuNiAxLjR6Ii8+PC9zdmc+)}</style><style>body,html{font-family:Roboto,"Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","微软雅黑",Arial,sans-serif}a{color:#00838f}#scheme-Paradox .hot_tags-count,#scheme-Paradox .sidebar-colored .sidebar-badge,#scheme-Paradox .sidebar-colored .sidebar-header,#scheme-Paradox .sidebar_archives-count,#search-form-label:after,#search-label,.mdl-card__media{background-color:#0097a7!important}#scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus,#scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover{color:#0097a7!important}#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a,#post_entry-right-info,.sidebar-colored .sidebar-nav li:hover>a,.sidebar-colored .sidebar-nav li:hover>a i,.sidebar-colored .sidebar-nav li>a:focus i,.sidebar-colored .sidebar-nav li>a:hover,.sidebar-colored .sidebar-nav li>a:hover i,.sidebar-colored .sidebar-nav>.open>a,.sidebar-colored .sidebar-nav>.open>a:focus,.sidebar-colored .sidebar-nav>.open>a:hover{color:#0097a7!important}.toTop{background:#757575!important}.material-layout .material-index>.material-nav,.material-layout .material-post>.material-nav,.material-nav a{color:#757575}#scheme-Paradox .MD-burger-layer{background-color:#757575}#scheme-Paradox #post-toc-trigger-btn{color:#757575}.post-toc a:hover{color:#00838f;text-decoration:underline}</style><style>body{background-color:#f5f5f5}#scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{background-color:#fff}</style><style>.fade{transition:all .8s linear;-webkit-transform:translate3d(0,0,0);-moz-transform:translate3d(0,0,0);-ms-transform:translate3d(0,0,0);-o-transform:translate3d(0,0,0);transform:translate3d(0,0,0);opacity:1}.fade.out{opacity:0}</style><link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><script>lsloader.load("js/jquery.min.js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==")</script><script>function Queue(){this.dataStore=[],this.offer=function(e){this.debug&&console.log("Offered a Queued Function."),"function"==typeof e?this.dataStore.push(e):console.log("You must offer a function.")},this.poll=function(){return this.debug&&console.log("Polled a Queued Function."),this.dataStore.shift()},this.execNext=function(){var e=this.poll();void 0!==e&&(this.debug&&console.log("Run a Queued Function."),e())},this.debug=!1,this.startDebug=function(){this.debug=!0}}var queue=new Queue</script><link rel="stylesheet" href="/css/prism-solarizedlight.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><link rel="stylesheet" href="/css/prism-solarizedlight.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body id="scheme-Paradox" class="lazy"><div class="material-layout mdl-js-layout has-drawer is-upgraded"><main class="material-layout__content" id="main"><div id="top"></div><button class="MD-burger-icon sidebar-toggle"><span class="MD-burger-layer"></span></button> <button id="post-toc-trigger-btn" class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">format_list_numbered</i></button><ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh;overflow-y:scroll"><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#前言"><span class="post-toc-number">1.</span> <span class="post-toc-text">前言</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#SSL证书"><span class="post-toc-number">2.</span> <span class="post-toc-text">SSL证书</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#选取合适的ssl证书"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">选取合适的ssl证书</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#开始获取SSL证书"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">开始获取SSL证书</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#acme-sh脚本"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">acme.sh脚本</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#前提条件"><span class="post-toc-number">2.2.1.1.</span> <span class="post-toc-text">前提条件</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#安装acme-sh脚本"><span class="post-toc-number">2.2.1.2.</span> <span class="post-toc-text">安装acme.sh脚本</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用DNS-API申请证书"><span class="post-toc-number">2.2.1.3.</span> <span class="post-toc-text">使用DNS API申请证书</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#安装证书"><span class="post-toc-number">2.2.1.4.</span> <span class="post-toc-text">安装证书</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#更新证书"><span class="post-toc-number">2.2.1.5.</span> <span class="post-toc-text">更新证书</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#更新-acme-sh"><span class="post-toc-number">2.2.1.6.</span> <span class="post-toc-text">更新 acme.sh</span></a></li></ol></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#应用实例"><span class="post-toc-number">3.</span> <span class="post-toc-text">应用实例</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#配置Nginx使用证书开通https站点"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">配置Nginx使用证书开通https站点</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#此步骤遇到的难题"><span class="post-toc-number">3.1.1.</span> <span class="post-toc-text">此步骤遇到的难题</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#测试证书"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">测试证书</span></a></li></ol></li></ol></ul><div class="material-post_container"><div class="material-post mdl-grid"><div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col"><div class="post_thumbnail-custom mdl-card__media mdl-color-text--grey-50" style="background-image:url(/images/15321623245664.jpg)"><p class="article-headline-p">全站开启https总结（艰苦历程？）</p></div><div class="mdl-color-text--grey-700 mdl-card__supporting-text meta"><div id="author-avatar"><img src="/img/avatar-Z.png" width="44px" height="44px" alt="Author Avatar"></div><div><strong>Reborn</strong> <span>7月 21, 2018</span></div><div class="section-spacer"></div><button id="article-functions-qrcode-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"><i class="material-icons" role="presentation">devices other</i> <span class="visuallyhidden">devices other</span></button><ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-qrcode-button"><li class="mdl-menu__item">在其它设备中阅读本文章</li><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACYklEQVR42u3aQXaDMAwFQO5/6fYAeSFfkjE0Ha/yUmI0LJAq6/j56nXg4eHh4eHh4eE9jHfE6/X6130+3PjNNeff57Hh4eHh7eRVw3oHPscn37/7XIgNDw8PbyPvPBkkAfWSR3J9EhseHh7eM3l5qqjuj4eHh/cfeElh3Vt4eHh4f4WX/MOfNB0m5fWCRgkeHh7eFt7kZX315xvO9/Dw8PBOec3BptbBVfJ9kgwKQ1d4eHh4F/DysCYDAdW/9lrGeHh4eDt5+St7jszZVSoeHh7eTl4eaLVxkA8NTA7e8PDw8PbzztNDvvU8hfQaynh4eHg7edW27HHZmj9uPDw8vD286lFWkgwmxXR+dzw8PLx7eUm4eaHcK7t7V+Lh4eHdy6syzm/fK5fzkro5dIWHh4e3iJcUr8moQSGIwbBCs0uNh4eHt4iX/KD6+p6MEVQfetSlxsPDw1vKy4eczgNNks1k4CCJBw8PD28PLy+Uc16vtdFLA1FJjYeHh3cxLx+QyscLquNceYlfTgx4eHh4i3iFHxcL3EnTFg8PD++ZvHlwvSO06sMaDV3h4eHhLeVVGxPVJkL1gK23Mx4eHt5OXrUVWy2Oe+OweSsEDw8Pbz+vuvLEcMVgQbIPHh4e3tW86uu42jLo7V/dDQ8PD28/r3rINEkqeQmeJCQ8PDy8e3nJyzopi3uJYd6GwMPDw3syb4Kcl+YfmhR4eHh4D+Plw1W9MYKkdG42I/Dw8PAu4OXNiFXJYJI8yiU1Hh4e3lLe5IAqaa32RhOi464rzvfw8PDwTnnft/Dw8PDw8PDw8B6wfgFfGMldgkKoJgAAAABJRU5ErkJggg=="></ul><button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"><i class="material-icons" role="presentation">bookmark</i> <span class="visuallyhidden">bookmark</span></button><ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button"><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/Linux/">Linux</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/SSL/">SSL</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/server/">服务器</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/operation/">运维</a></li></ul><button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"><i class="material-icons" role="presentation">share</i> <span class="visuallyhidden">share</span></button><ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button"><a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=全站开启https总结（艰苦历程？）&url=https://reb.mallotec.com/posts/41e1ea07.html&pic=&searchPic=false&style=simple" target="_blank"><li class="mdl-menu__item">分享到微博</li></a><a class="post_share-link" href="https://twitter.com/intent/tweet?text=全站开启https总结（艰苦历程？）&url=https://reb.mallotec.com/posts/41e1ea07.html&via=Reborn" target="_blank"><li class="mdl-menu__item">分享到 Twitter</li></a><a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=https://reb.mallotec.com/posts/41e1ea07.html" target="_blank"><li class="mdl-menu__item">分享到 Facebook</li></a><a class="post_share-link" href="https://plus.google.com/share?url=https://reb.mallotec.com/posts/41e1ea07.html" target="_blank"><li class="mdl-menu__item">分享到 Google+</li></a><a class="post_share-link" href="https://telegram.me/share/url?url=https://reb.mallotec.com/posts/41e1ea07.html&text=全站开启https总结（艰苦历程？）" target="_blank"><li class="mdl-menu__item">分享到 Telegram</li></a></ul></div><div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在搭建完Hexo之后，我就开始思考要不要配置https呢？最后深思熟虑，还是决定上https吧！毕竟现在https已经开始普及，像Chrome、Firfox这些浏览器如果不是https协议的会提示如下图，警告“不安全”什么的。强迫症患者表示看着最不舒服了（逃～<br><img src="/images/http%20browser%20show.jpg" alt="http browser sho"></p><p>于是我就开始了配置https之路……<br><a id="more"></a></p><h1 id="SSL证书"><a href="#SSL证书" class="headerlink" title="SSL证书"></a>SSL证书</h1><h2 id="选取合适的ssl证书"><a href="#选取合适的ssl证书" class="headerlink" title="选取合适的ssl证书"></a>选取合适的ssl证书</h2><p>https = http + ssl，所以要走https协议首先要申请ssl证书。<br>但是我第一次建站，对ssl证书一点都不懂啊！！哪个ssl证书更好我也不知道，去搜索一翻发现各种说法，最后还是去请教了各位前辈。<br>经过各位前辈的建议，我了解到了<code>Let&#39;s Encrypt</code>，详细介绍我就不说了，这是<a href="https://zh.wikipedia.org/zh-hans/Let%27s_Encrypt" target="_blank" rel="noopener">它在维基百科的资料</a>，然后这是<a href="https://letsencrypt.org" target="_blank" rel="noopener">官网</a></p><p>除此之外还有<a href="https://www.digicert.com" target="_blank" rel="noopener">Digicert</a>、<a href="https://www.sslforfree.com" target="_blank" rel="noopener">SSL For Free</a>、<a href="http://www.cacert.org" target="_blank" rel="noopener">CA Cert</a>。Digicert很贵，但是据某位前辈说似乎大企业喜欢用它的挺多，而且人家还支持签发 .onion 域名的证书（EV）。</p><p>看自己需求吧，我最后还是用了<code>Let&#39;s Encrypt</code>。<br>老父亲说这是免费的，但验证过程要在服务器上做，有点复杂。我觉得复杂点没所谓，好用就行。<br>某群里的前辈说也可以不验证，自签名就好（其实我还没懂哈哈哈，尴尬.jpg）；前辈们还说了一种DNS方式验证，不需要架设额外服务；在我问了“Let’s encrypt用standalone还是webroot模式更好”之后(其实这个我也不懂)，<font color="red"><strong>终于决定用DNS模式</strong></font>，DNS 模式更方便，还可以签通配符证书。</p><h2 id="开始获取SSL证书"><a href="#开始获取SSL证书" class="headerlink" title="开始获取SSL证书"></a>开始获取SSL证书</h2><p>参考：<a href="http://www.racksam.com/2016/12/26/centos-nginx-setup-lets-encrypt-with-acme-sh/" target="_blank" rel="noopener">使用acme.sh脚本的DNS API方式申请及更新let’s encrypt证书</a></p><p>群里多位前辈介绍了一个在 Linux 上申请let’s encrypt证书的脚本——<a href="https://github.com/Neilpang/acme.sh" target="_blank" rel="noopener">acme.sh</a></p><h3 id="acme-sh脚本"><a href="#acme-sh脚本" class="headerlink" title="acme.sh脚本"></a>acme.sh脚本</h3><p>Linux服务器下使用acme.sh脚本是申请let’s encrypt证书最便捷的方式，比官方推荐的<code>certbot</code>脚本工具要方便强大的多。好处是对环境要求较低，路由器上 busybox ash 都能跑，只需要使用到 curl 等少数几个外部程序</p><p>安装文档： <a href="https://github.com/Neilpang/acme.sh/wiki/说明" target="_blank" rel="noopener">https://github.com/Neilpang/acme.sh/wiki/说明</a></p><h4 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h4><ol><li>拥有一个域名，例如 mydomain.com (在国内主机的用的话，还需要通过ICP备案)</li><li>确定二级域名，并且在域名服务器创建一条A记录，执行云主机的公网IP地址。<a href="http://www.mydomain.com指向xxx.xxx.xxx.xxx的IP地址" target="_blank" rel="noopener">www.mydomain.com指向xxx.xxx.xxx.xxx的IP地址</a></li><li>要等到新创建的域名解析能在公网上被解析到。</li><li>据说国内的域名提供商对letsencrypt的支持非常差，但是据说现阶段用dnspod解析的域名还没碰到问题。我用的是国外的Cloudflare解析我的域名，但是经常被墙（想骂人…），移动表示大多数都没有体验= =，联通情况好一点。</li></ol><h4 id="安装acme-sh脚本"><a href="#安装acme-sh脚本" class="headerlink" title="安装acme.sh脚本"></a>安装acme.sh脚本</h4><p>执行一下命令后重新ssh登录服务器即可：</p><pre class="line-numbers language-bash"><code class="language-bash">curl  https://get.acme.sh <span class="token operator">|</span> sh
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>该命令会把 acme.sh 安装到你的 home 目录下: <code>~/.acme.sh/</code>，一般会自动创建环境变量，后期直接命令行输入acme.sh即可。</p><h4 id="使用DNS-API申请证书"><a href="#使用DNS-API申请证书" class="headerlink" title="使用DNS API申请证书"></a>使用DNS API申请证书</h4><p>(推荐配置使用API的方式，否则每隔三个月，仍然需要重新验证DNS TXT记录)</p><p>创建DNS API的Key及Secret</p><blockquote><p>参考：</p><ol><li><a href="https://github.com/Neilpang/acme.sh/tree/master/dnsapi" target="_blank" rel="noopener">https://github.com/Neilpang/acme.sh/tree/master/dnsapi</a></li><li><a href="https://github.com/Neilpang/acme.sh/blob/master/dnsapi/README.md" target="_blank" rel="noopener">https://github.com/Neilpang/acme.sh/blob/master/dnsapi/README.md</a></li></ol></blockquote><p>acme.sh 目前支持 cloudflare, dnspod, cloudxns, godaddy 以及 ovh 等数十种解析商的自动集成.</p><p><strong>【例子一】域名由Cloudflare提供解析的网站，使用CloudFlare域名API自动颁发证书</strong></p><ol><li><p>以 Cloudflare 为例, 你需要先登录到 Cloudflare 账号才能获得API密钥, 都是免费的。<br><img src="/images/Cloudflare-Api-1.jpg" alt="Cloudflare-Api-1"></p><p><img src="/images/Cloudflare-Api-2.jpg" alt="Cloudflare-Api-2"></p></li><li><p>然后在Linux下使用acme.sh命令申请证书:</p><p>命令使用参考：<a href="https://sb.sb/blog/linux-acme-sh-lets-encrypt-ssl/" target="_blank" rel="noopener">Linux 下使用 acme.sh 配置 Let’s Encrypt 免费 SSL 证书 + 通配符证书</a><br>先导入密钥和邮箱：</p><pre class="line-numbers language-bash"><code class="language-bash"> <span class="token function">export</span> CF_Key<span class="token operator">=</span><span class="token string">"sdfsdfsdfljlbjkljlkjsdfoiwje"</span>
 <span class="token function">export</span> CF_Email<span class="token operator">=</span><span class="token string">"xxxx@sss.com"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>我们现在发行一个证书：</p><pre class="line-numbers language-bash"><code class="language-bash">  acme.sh --issue --dns dns_cf -d example.com -d www.example.com --accountemail query@goodsrv.com
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>--accountemail</code>是指定帐户电子邮件，仅对<code>--install</code>和<code>--update-account</code>命令有效（待验证，因为我执行命令时并没有带上该参数）。</p><p>输入命令后回车，需要等两分钟，终端会有倒计时。</p><p>倒计时结束后，执行命令：</p><pre class="line-numbers language-bash"><code class="language-bash"> acme.sh --renew -d example.com -d www.example.com
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><h4 id="安装证书"><a href="#安装证书" class="headerlink" title="安装证书"></a>安装证书</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 创建安装目录</span>
<span class="token function">mkdir</span> /etc/ssl/example.com/ -p

<span class="token comment" spellcheck="true"># reloadcmd参数里面填写的是在更新证书后需要重新启动的服务，例如重启nginx或者apache或者其它脚本。</span>
acme.sh  --installcert  -d  example.com   \
        --key-file   /etc/ssl/example.com/example.com.key \
        --fullchain-file /etc/ssl/example.com/fullchain.cer \
        --reloadcmd  <span class="token string">"systemctl reload nginx"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注意：</strong></p><ol><li><code>/etc/ssl/example.com/</code>的所有者以及用户组必须为当前用户，否则后面installcert的时候会提示没有权限，可执行如下命令，后面可更改回原来的所有者和用户组：<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#更改所有者和用户组</span>
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable">$USER</span><span class="token keyword">:</span><span class="token variable">$USER</span> -R /etc/ssl/example.com/
<span class="token comment" spellcheck="true">#查看指定文件夹的权限、所有者和用户组</span>
<span class="token function">ls</span> -l /etc/ssl/
<span class="token function">ls</span> -l /etc/ssl/example.com/
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>(一个小提醒, 部分服务器系统用的是 <code>service nginx force-reload</code>, 不是 <code>service nginx reload</code>, 据测试, <code>reload</code> 并不会重新加载证书, 所以用的 <code>force-reload</code>)</li><li>Nginx 的配置 <code>ssl_certificate</code> 使用 <code>/etc/nginx/ssl/fullchain.cer</code> ，而非 <code>/etc/nginx/ssl/&lt;domain&gt;.cer</code> ，否则 <a href="https://www.ssllabs.com/ssltest/" target="_blank" rel="noopener">SSL Labs</a>的测试会报 <code>Chain issues Incomplete</code> 错误。</li><li><code>--installcert</code>命令可以携带很多参数, 来指定目标文件. 并且可以指定 reloadcmd, 当证书更新以后, reloadcmd 会被自动调用,让服务器生效.</li><li>值得注意的是, 这里指定的所有参数都会被自动记录下来, 并在将来证书自动更新以后, 被再次自动调用.</li></ol></blockquote><blockquote><p>mkdir的-p参数解释：<br>-p, –parents 可以是一个路径名称。此时若路径中的某些目录尚不存在,加上此选项后,系统将自动建立好那些尚不存在的目录,即一次可以建立多个目录;<br>mkdir命令参考：<a href="https://www.linuxdaxue.com/linux-command-intro-mkdir.html" target="_blank" rel="noopener">https://www.linuxdaxue.com/linux-command-intro-mkdir.html</a></p></blockquote><h4 id="更新证书"><a href="#更新证书" class="headerlink" title="更新证书"></a>更新证书</h4><p>目前证书在 60 天以后会自动更新, 你无需任何操作. 今后有可能会缩短这个时间, 不过都是自动的, 你不用关心.</p><h4 id="更新-acme-sh"><a href="#更新-acme-sh" class="headerlink" title="更新 acme.sh"></a>更新 acme.sh</h4><p>目前由于 acme 协议和 letsencrypt CA 都在频繁的更新, 因此 acme.sh 也经常更新以保持同步.</p><p>升级 acme.sh 到最新版 :</p><pre class="line-numbers language-bash"><code class="language-bash">acme.sh --upgrade
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果你不想手动升级, 可以开启自动升级:</p><pre class="line-numbers language-bash"><code class="language-bash">acme.sh  --upgrade  --auto-upgrade
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>之后, acme.sh 就会自动保持更新了<br>你也可以随时关闭自动更新:</p><pre class="line-numbers language-bash"><code class="language-bash">acme.sh --upgrade  --auto-upgrade  0
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="应用实例"><a href="#应用实例" class="headerlink" title="应用实例"></a>应用实例</h1><h2 id="配置Nginx使用证书开通https站点"><a href="#配置Nginx使用证书开通https站点" class="headerlink" title="配置Nginx使用证书开通https站点"></a>配置Nginx使用证书开通https站点</h2><ol><li><p><strong>生成Perfect Forward Security（PFS）键值</strong><br>Perfect Forward Security（PFS)是个什么东西，我也不清楚，中文翻译成<code>完美前向保密</code>，反正是这几年才提倡的加强安全性的技术。如果本地还没有生成这个键值，需要先执行生成的命令。</p><pre class="line-numbers language-bash"><code class="language-bash">/etc/ssl/example.com/
openssl dhparam -out dhparam.pem 2048
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>生成的过程还挺花时间的，据我查到的资料，据说参数为2048的要4分钟左右，还受服务器性能影响，此时不妨做点其他东西。<br>（时间一分一秒的过去…）<br>好了，PFS键值生成了，我们用<code>ls</code>命令来确认一下目录下是否生成了<code>dhparam.pem</code>文件，确认完毕就可以执行下一步了。</p><blockquote><p>特别说明：<br>一定要确认文件是否已经生成！！！在这一步我原本是执行<code>openssl dhparam 2048 -out dhparam.pem</code>，不知道为什么执行了多次都无法生成<code>dhparam.pem</code>文件，后来换了个目录执行了多次<code>openssl dhparam -out dhparam.pem 2048</code>才成功，这是后面配置完Nginx后无法重新启动Nginx服务了，我输出日志才发现的，具体后面会说。</p></blockquote></li><li><p><strong>nginx配置使用证书。</strong><br>编辑你的Nginx配置文件，如：<code>/etc/nginx/sites-available/&lt;your-nginx-config&gt;</code><br><font color="red">☆☆修改配置文件前建议先备份☆☆</font><br>可以通过<a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/" target="_blank" rel="noopener">Mozilla SSL Configuration Generator</a>自动生成对应的参考配置</p><p><strong>修改http对应的server模块：</strong></p><pre class="line-numbers language-nginx"><code class="language-nginx"> <span class="token keyword">server</span> <span class="token punctuation">{</span>
     <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
     <span class="token keyword">listen</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">;</span>
     <span class="token keyword">server_name</span> example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">#return 301 https://example.com$request_uri;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$scheme</span> <span class="token operator">=</span> <span class="token keyword">http</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token number">301</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$server_name</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">root</span> <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
     <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>return 301 https://$server_name$request_uri;</code>是强制http跳转https</p></blockquote><p><strong>在配置文件中添加https的server模块：</strong></p><pre class="line-numbers language-nginx"><code class="language-nginx"> <span class="token keyword">server</span> <span class="token punctuation">{</span>
     <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span><span class="token punctuation">;</span>
     <span class="token keyword">server_name</span> example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>

     <span class="token comment" spellcheck="true">#charset utf-8;</span>
     <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token keyword">root</span> <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">#index index.html index.htm;</span>
     <span class="token punctuation">}</span>
     <span class="token comment" spellcheck="true">#root /var/www/html/example.com;</span>
     <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>

     <span class="token keyword">access_log</span>  <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>example<span class="token punctuation">.</span>com_access<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
     <span class="token keyword">error_log</span>  <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>example<span class="token punctuation">.</span>com_error<span class="token punctuation">.</span>log<span class="token punctuation">;</span>

     <span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>etc<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>fullchain<span class="token punctuation">.</span>cer<span class="token punctuation">;</span>
     <span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>etc<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token punctuation">.</span>key<span class="token punctuation">;</span>

     <span class="token keyword">ssl_session_timeout</span> 1d<span class="token punctuation">;</span>
     <span class="token keyword">ssl_session_cache</span> shared<span class="token punctuation">:</span><span class="token keyword">SSL</span><span class="token punctuation">:</span>50m<span class="token punctuation">;</span>
     ssl_session_tickets off<span class="token punctuation">;</span>

     <span class="token keyword">ssl_dhparam</span> <span class="token operator">/</span>etc<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>dhparam<span class="token punctuation">.</span>pem<span class="token punctuation">;</span>

     <span class="token keyword">ssl_protocols</span> TLSv1 TLSv1<span class="token number">.1</span> TLSv1<span class="token number">.2</span><span class="token punctuation">;</span>
     <span class="token keyword">ssl_ciphers</span> <span class="token string">'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128:AES256:AES:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK'</span><span class="token punctuation">;</span>
     <span class="token keyword">ssl_prefer_server_ciphers</span> on<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>总的样例内容如下：</strong></p><pre class="line-numbers language-nginx"><code class="language-nginx"> <span class="token keyword">server</span> <span class="token punctuation">{</span>
     <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
     <span class="token keyword">listen</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">;</span>
     <span class="token keyword">server_name</span> example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">#return 301 https://example.com$request_uri;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$scheme</span> <span class="token operator">=</span> <span class="token keyword">http</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token number">301</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$server_name</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">root</span> <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
     <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">server</span> <span class="token punctuation">{</span>
     <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span><span class="token punctuation">;</span>
     <span class="token keyword">server_name</span> example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>

     <span class="token comment" spellcheck="true">#charset utf-8;</span>
     <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token keyword">root</span> <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">#index index.html index.htm;</span>
     <span class="token punctuation">}</span>
     <span class="token comment" spellcheck="true">#root /var/www/html/example.com;</span>
     <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>

     <span class="token keyword">access_log</span>  <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>example<span class="token punctuation">.</span>com_access<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
     <span class="token keyword">error_log</span>  <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>example<span class="token punctuation">.</span>com_error<span class="token punctuation">.</span>log<span class="token punctuation">;</span>

     <span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>etc<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>fullchain<span class="token punctuation">.</span>cer<span class="token punctuation">;</span>
     <span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>etc<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token punctuation">.</span>key<span class="token punctuation">;</span>

     <span class="token keyword">ssl_session_timeout</span> 1d<span class="token punctuation">;</span>
     <span class="token keyword">ssl_session_cache</span> shared<span class="token punctuation">:</span><span class="token keyword">SSL</span><span class="token punctuation">:</span>50m<span class="token punctuation">;</span>
     ssl_session_tickets off<span class="token punctuation">;</span>

     <span class="token keyword">ssl_dhparam</span> <span class="token operator">/</span>etc<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>dhparam<span class="token punctuation">.</span>pem<span class="token punctuation">;</span>

     <span class="token keyword">ssl_protocols</span> TLSv1 TLSv1<span class="token number">.1</span> TLSv1<span class="token number">.2</span><span class="token punctuation">;</span>
     <span class="token keyword">ssl_ciphers</span> <span class="token string">'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128:AES256:AES:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK'</span><span class="token punctuation">;</span>
     <span class="token keyword">ssl_prefer_server_ciphers</span> on<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置文件没有问题的话执行<code>systemctl reload nginx</code>，然后在浏览器打开<code>http://example.com</code>, 如果正常跳转到<code>https://example.com</code>，就算成功了。 如果是chrome浏览器，在地址栏点击绿色小锁的图标，可以查看证书的详情，如图。<br><img src="/images/https%20browser%20show.png" alt="https browser sho"></p></li></ol><h3 id="此步骤遇到的难题"><a href="#此步骤遇到的难题" class="headerlink" title="此步骤遇到的难题"></a>此步骤遇到的难题</h3><ol><li><p>这里要注意的是如果你是<code>Nginx+Cloudflare</code>，那么Cloudflare的”Crypto—SSL”要设置成<code>Full(strict)</code>，否则会导致<font color="orange"><strong>example.com将你重定向次数过多</strong></font>的情况，默认是<code>Flexible</code>。CF设置如图：<br><img src="/images/cloudflare%20config%20of%20starting%20https%20with%20nginx.png" alt="cloudflare config of starting https with nginx"></p></li><li><p>这里还有个坑就是前面说的无法生成<code>dhparam.pem</code>文件导致无法重载Nginx。一开始我还没发现，一直在以为Nginx配置文件哪里错了，后来<code>sudo journalctl -xe</code>输出日志才发现Nginx找不到<code>dhparam.pem</code>文件：<br><img src="/images/nginx%20cannot%20found%20dhparam.pem-1.png" alt="nginx cannot found dhparam.pem-1"><br>用<code>ls</code>命令可以发现目录下并不存在<code>dhparam.pem</code>文件：<br><img src="/images/nginx%20cannot%20found%20dhparam.pem-2.png" alt="nginx cannot found dhparam.pem-2"><br>于是我又执行了几次<code>openssl dhparam 2048 -out dhparam.pem</code>，结果还是一样，而且过程竟然只需要1分钟不到。如图：<br><img src="/images/nginx%20cannot%20found%20dhparam.pem-3.png" alt="nginx cannot found dhparam.pem-3"><br>察觉到不对劲之后我马上去找了跟<code>dhparam</code>的资料，后来在一个博客上发现他的命令顺序跟我不一样，这个文件存放目录也跟我不一样，于是我就把命令改成<code>openssl dhparam -out dhparam.pem 2048</code>和改目录到example.com(此时该目录权限还是$USER的)再试了几次，第一次是不行的，执行多几次后突然就成功了。如图：<br><img src="/images/nginx%20cannot%20found%20dhparam.pem-4.png" alt="nginx cannot found dhparam.pem-4"><br>可以发现此次执行命令时间十分的长，我等了大概5分钟才执行完毕。<br>然后我们再用<code>ls</code>来看看目录下的文件，可以发现文件已经生成：<br><img src="/images/nginx%20cannot%20found%20dhparam.pem-5.png" alt="nginx cannot found dhparam.pem-5"></p></li></ol><h2 id="测试证书"><a href="#测试证书" class="headerlink" title="测试证书"></a>测试证书</h2><p>如果是网站的话，可以使用第三方网站工具测试自己网站的HTTPS配置的安全性</p><ol><li><p>SSL Lab就是个不错的选择：<br><a href="https://ssllabs.com/ssltest/analyze.html?d=example.com" target="_blank" rel="noopener">https://ssllabs.com/ssltest/analyze.html?d=example.com</a><br>这是我的测试结果，都是A哦！！<br><img src="/images/SSL%20Lab%20Server%20Test.jpg" alt="SSL Lab Server Test"></p></li><li><p>也可以在Linux下使用openssl命令查看证书的过期时间</p><pre class="line-numbers language-bash"><code class="language-bash"> openssl x509 -noout -dates -in /etc/ssl/example.com/example.com.key
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><div><br><ul id="post-license" class="post-license"><li class="post-license-author"><strong>本文作者：</strong> <a href="https://reb.mallotec.com">Reborn</a></li><li class="post-license-link"><strong>本文链接：</strong> <a href="https://reb.mallotec.com/posts/41e1ea07.html">全站开启https总结（艰苦历程？）</a></li><li class="post-license-statement"><strong>版权声明： </strong>本文由 Reborn 原创，采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="license" target="_blank">署名-非商业性使用-相同方式共享（CC BY-NC-SA）4.0 国际许可协议</a><br>转载请保留以上声明信息！</li></ul></div></div><link rel="stylesheet" href="/disqus-php-api-dist/iDisqus.min.css"><script src="/disqus-php-api-dist/iDisqus.min.js"></script><div id="comment"><script>var emojiList=[{code:"smile",title:"笑脸",unicode:"1f604"},{code:"mask",title:"生病",unicode:"1f637"},{code:"joy",title:"破涕为笑",unicode:"1f602"},{code:"stuck_out_tongue_closed_eyes",title:"吐舌",unicode:"1f61d"},{code:"flushed",title:"脸红",unicode:"1f633"},{code:"scream",title:"恐惧",unicode:"1f631"},{code:"pensive",title:"失望",unicode:"1f614"},{code:"unamused",title:"无语",unicode:"1f612"},{code:"grin",title:"露齿笑",unicode:"1f601"},{code:"heart_eyes",title:"色",unicode:"1f60d"},{code:"sweat",title:"汗",unicode:"1f613"},{code:"smirk",title:"得意",unicode:"1f60f"}],disq=new iDisqus("comment",{forum:"rebor",site:"https://reb.mallotec.com",api:"https://api.mallotec.com/reborn/disqus-php-api/api",mode:"1",badge:"Reborn",timeout:"3000",init:!0,autoCreate:!0,emoji_list:emojiList});disq.count()</script></div><style>#comment{background-color:#eee;padding:2pc}</style></div><nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col"><a href="/posts/832fa05b.html" id="post_nav-newer" class="prev-content"><button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation"><i class="material-icons">arrow_back</i></button> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 新篇</a><div class="section-spacer"></div><a href="/posts/1572acec.html" id="post_nav-older" class="next-content">旧篇 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation"><i class="material-icons">arrow_forward</i></button></a></nav></div></div><div class="sidebar-overlay"></div><aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation"><div id="sidebar-main"><div class="sidebar-header header-cover" style="background-image:url(/img/sidebar_header.png)"><div class="top-bar"></div><button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display:initial" data-upgraded=",MaterialButton,MaterialRipple"><i class="material-icons">clear_all</i> <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button><div class="sidebar-image"><img src="/img/avatar-Z.png" alt="Reborn's avatar"></div><a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown" rel="external nofollow">Ren.Xiaoyao58@gmail.com <b class="caret"></b></a></div><ul class="nav sidebar-nav"><li class="dropdown"><ul id="settings-dropdown" class="dropdown-menu"><li><a href="mailto: Ren.Xiaoyao58@gmail.com" target="_blank" title="Email Me" rel="external nofollow"><i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i> Email Me</a></li></ul></li><li id="sidebar-first-li"><a href="/" rel="external nofollow"><i class="material-icons sidebar-material-icons">home</i> 主页</a></li><li class="dropdown"><a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown" rel="external nofollow"><i class="material-icons sidebar-material-icons">inbox</i> 归档 <b class="caret"></b></a><ul class="dropdown-menu"><li><a class="sidebar_archives-link" href="/archives/2018/08/">八月 2018<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/07/">七月 2018<span class="sidebar_archives-count">6</span></a></li></ul></li><li class="dropdown"><a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown" rel="external nofollow"><i class="material-icons sidebar-material-icons">chrome_reader_mode</i> 分类 <b class="caret"></b></a><ul class="dropdown-menu"><li><a class="sidebar_archives-link" href="/categories/hexo/">hexo<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/categories/database/">数据库<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/categories/log-server/">运维日志<span class="sidebar_archives-count">1</span></a></li></ul></li><li><a href="/tags" title="标签云" rel="external nofollow"><i class="material-icons sidebar-material-icons">bookmark</i> 标签云</a></li><li class="divider"></li><li><a href="/timeline" title="时间轴" rel="external nofollow"><i class="material-icons sidebar-material-icons">send</i> 时间轴</a></li><li><a href="/gallery" title="图库" rel="external nofollow"><i class="material-icons sidebar-material-icons">photo_library</i> 图库</a></li><li><a href="/about" title="关于我" rel="external nofollow"><i class="material-icons sidebar-material-icons">person</i> 关于我</a></li><li class="divider"></li><li><a href="/archives" rel="external nofollow">文章总数 <span class="sidebar-badge">9</span></a></li></ul></div></aside><div id="back-to-top" class="toTop-wrap"><a href="#top" class="toTop"><i class="material-icons footer_top-i">expand_less</i></a></div><footer class="mdl-mini-footer" id="bottom"><div class="mdl-mini-footer--left-section sns-list"><a href="https://github.com/Arcobaleno0" target="_blank"><button class="mdl-mini-footer--social-btn social-btn footer-sns-github"><span class="visuallyhidden">Github</span></button></a></div><div id="copyright">Copyright&nbsp;©&nbsp;2018&nbsp;-<script type="text/javascript">var fd=new Date;document.write("&nbsp;"+fd.getFullYear()+"&nbsp;")</script>Reborn's Blog</div><div class="mdl-mini-footer--right-section"><div><div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow">Hexo</a></div><div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a" rel="external nofollow">Material</a></div></div></div></footer><script>lsloader.load("js/lazyload.min.js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==")</script><script>lsloader.load("js/js.min.js","/js/js.min.js?oAl/+lvaqTFV31JXTmbrNA==")</script><script>lsloader.load("js/nprogress.js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==")</script><script type="text/ls-javascript" id="NProgress-script">NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);</script><script>var agent=navigator.userAgent.toLowerCase();0<agent.indexOf("ucbrowser")&&(document.write('<link rel="stylesheet" href="/css/uc.css">'),alert("由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。"))</script><script type="text/ls-javascript" id="window-load">$(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });</script><script type="text/ls-javascript" id="lazy-load">// Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });</script><script>!function(){for(var e=document.querySelectorAll('script[type="text/ls-javascript"]'),r=0;r<e.length;++r){var o=e[r];lsloader.runInlineScript(o.id,o.id)}}(),console.log("\n %c © Material Theme | Version: 1.4.0 | https://github.com/viosey/hexo-theme-material %c \n","color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;","color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;")</script></main></div></body></html>